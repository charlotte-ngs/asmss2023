---
output:
  pdf_document:
    includes:
      in_header: tex/header.tex
    fig_caption: no
    keep_tex: no
  html_document:
    df_print: paged
output_file: asm_exam_tsk.pdf
params:
  seed: 1846
  name: "von Rohr"
  firstname: Peter
  leginr: "88-918-123"
  examdate: "2023-05-22"
  alias: test
--- 
<!-- %\usepackage{fancyhdr} -->

\newcommand{\points}[1]
{\begin{flushright}\textbf{#1}\end{flushright}}

<!-- %\begin{document} -->
<!-- %\SweaveOpts{concordance=TRUE} -->
```{r ChunkOptions, echo=FALSE}
# knitr::opts_chunk$set(echo = FALSE, results = 'hide')
#knitr::opts_chunk$set(concordance=TRUE)
knitr::knit_hooks$set(hook_convert_odg = rmdhelp::hook_convert_odg)
# write the parameters to file
b_params_to_file <- FALSE
# check whether seed is set and output it to a file
s_this_rmd_file = basename(ifelse(rstudioapi::isAvailable(), 
                         rstudioapi::getSourceEditorContext()$path, 
                         whereami::thisfile()))
if (is.null(params$seed)){
  stop(" ** Error parameter seed has not been set.")
} else {
  set.seed(params$seed)
  s_params_file <- paste0(format(Sys.time(), '%Y%m%d%H%M%S'), "_params_", s_this_rmd_file, ".txt", collapse = "")
  if (b_params_to_file) dput(params, file = s_params_file)
}
```

```{r PointsQ1, echo=FALSE}
# Assign Points for Q1
lPointsQ1 <- list(TaskA = 4,
                  TaskB = 14,
                  TaskC = 5,
                  TaskD = 0)
nPointQ1Total <- sum(unlist(lPointsQ1))
```

```{r PointsQ2, echo=FALSE}
# Assign Points for Q2
lPointsQ2 <- list(TaskA = 2,
                  TaskB = 2,
                  TaskC = 8,
                  TaskD = 0)
nPointQ2Total <- sum(unlist(lPointsQ2))
```

```{r PointsQ3, echo=FALSE}
# Assign Points for Q3
lPointsQ3 <- list(TaskA = 25,
                  TaskB = 25,
                  TaskC = 0,
                  TaskD = 0)
nPointQ3Total <- sum(unlist(lPointsQ3))
```

```{r PointsQ4, echo=FALSE}
# Assign Points for Q4
lPointsQ4 <- list(TaskA = 20,
                  TaskB = 20,
                  TaskC = 0,
                  TaskD = 0)
nPointQ4Total <- sum(unlist(lPointsQ4))
```

```{r PointsQ5, echo=FALSE}
# Assign Points for Q4
lPointsQ5 <- list(TaskA = 8,
                  TaskB = 8,
                  TaskC = 0,
                  TaskD = 0)
nPointQ5Total <- sum(unlist(lPointsQ5))
```

```{r PointsTotal, echo=FALSE}
nPointOverallTotal <- nPointQ1Total + nPointQ2Total + nPointQ3Total + nPointQ4Total + nPointQ5Total
```


\thispagestyle{empty}

\fcolorbox{white}{white}{
	\centering \parbox[t]{1.0\linewidth}{
		\fontsize{12pt}{20pt}\selectfont % 
		\vspace*{0.5cm} % 

   	Peter von Rohr \\ Institute of Agricultural Sciences\\ D-USYS\\ ETH Zurich

		\vspace*{0.5cm} 
	}
}

\vspace*{2cm}

\fcolorbox{white}{white}{
	\parbox[t]{1.0\linewidth}{
		\centering \fontsize{25pt}{40pt}\selectfont %
		\vspace*{0.2cm}
		 751-7602-00 V \\
     Exam in    \\
     Applied Statistical Methods \\
     in Animal Sciences \\
     Spring Semester 2023

		\vspace*{0.7cm} % Space between the end of the title and the bottom of the grey box
	}
}


\vspace*{0.5cm}

<!-- % Table with Name -->
\begin{tabular}{p{3cm}p{6cm}}
Date:     &  `r params$examdate` \\
          &  \\
          &  \\
Name:     &  \\
          &  \\
          &  \\
Legi-Nr:  &  \\
\end{tabular}

<!-- % Table with Points -->

\vspace{3ex}
\begin{center}
\begin{tabular}{|p{3cm}|c|c|}
\hline
Problem  &  Maximum Number of Points  &  Number of Points Reached\\
\hline
1        &  `r nPointQ1Total`  & \\
\hline
2        &  `r nPointQ2Total`  & \\
\hline
3        &  `r nPointQ3Total`  & \\
\hline
4        &  `r nPointQ4Total`  & \\
\hline
5        &  `r nPointQ5Total`  & \\
\hline
Total    &  `r nPointOverallTotal` & \\
\hline
\end{tabular}
\end{center}

\vspace{0.25cm}

\textit{Questions in German are in italics}

\clearpage
\pagebreak

```{r, asm_exam_general_setup, echo=FALSE}
s_data_url_root <- "https://charlotte-ngs.github.io/asmss2023/data"
```



## Problem 1: Linear Regression
```{r asm_exam_p1_setup, echo=FALSE, message=FALSE, warning=FALSE}
s_data_url_p1 <- file.path(s_data_url_root, "asm_exam_p01.csv")
tbl_p1 <- readr::read_delim(file = s_data_url_p1, delim = ",")
n_nr_cow <- nrow(tbl_p1)
```

Given is the following dataset on methane yield (in g/kg of Dry Matter Intake) and the nonvolatile milk metabolite acetone (as NMR-based relative area) for `r n_nr_cow` cows. The dataset is available under the link shown below the table

\textit{Gegeben ist der nachfolgend gezeigte Datensatz mit Methan (in g/kg Trockensubstanzaufnahme) und dem nicht-flüchtigen Milkmetaboliten Aceton (als relative Fläche aus der NMR) für `r n_nr_cow` Kühe. Der Datensatz ist verfügbar unter dem Link, welcher unter der Tabelle gezeigt wird.}

```{r asm_exam_p1_show_tbl, echo=FALSE}
knitr::kable(tbl_p1,
             booktabs = TRUE,
             longtable = TRUE)

```

```{r asm_exam_p1_data_url, echo=FALSE}
cat(s_data_url_p1, "\n")
```


\begin{enumerate}
\item[a)] Fit a linear regression model with methane yield as response variable and acetone as predictor variable. What are the estimated values for 

\begin{itemize}
\item the slope, 
\item the intercept and 
\item the standard deviation of the residuals
\end{itemize}

based on fitted regression model?

\textit{Passen Sie ein lineares Regressionsmodell an mit Methan als Zielgrösse und Aceton als unabhängiger Variable (Predictor). Wie gross sind die aufgrund des Regressionsmodells geschätzten Werte für}

\begin{itemize}
\item \textit{die Steigung},
\item \textit{der Achsenabschnitt und }
\item \textit{die Standardabweichung der Residuen}
\end{itemize}

\end{enumerate}
\points{`r lPointsQ1$TaskA`}

\clearpage
\pagebreak

### Solution


\clearpage
\pagebreak

\begin{enumerate}
\item[b)] The plot below shows a scatter-plot of the given data on Acetone and Methane together with the fitted regression line. Please enter into the plot the slope, the intercept and all residuals. 

\textit{Die unten gezeigte Grafik zeigt den Scatterplot der gegebenen Daten zu Aceton und Methan zusammen mit der angepassten Regressionslinie. Bitte zeichnen Sie in den gegebenen Plot die folgenden Grössen ein: Steigung, Achsenabschnitt und alle Residuen}

\end{enumerate}
\points{`r lPointsQ1$TaskB`}


### Solution 

```{r, echo=FALSE}
lm_p1 <- lm(formula = Methane ~ Acetone, data = tbl_p1)
library(ggplot2)
ggplot(data = tbl_p1,
       aes(x = Acetone, y = Methane)) + 
  geom_point() + 
  geom_abline(slope = lm_p1$coefficients[["Acetone"]],
              intercept = lm_p1$coefficients[["(Intercept)"]],
              color = "red") + 
  xlim(c(0, 1.1*max(tbl_p1$Acetone))) + 
  ylim(c(0.95 * min(tbl_p1$Methane),  lm_p1$coefficients[["(Intercept)"]]))
      
```



\clearpage
\pagebreak

```{r asm-exam-p1c-setup, echo=FALSE}
n_add_cows <- 3
n_intercept_value <- 25
n_slope_value <- -40
vec_acetone <- c(0.0532, 0.012, 0.109)
```


\begin{enumerate}
\item[c)] The table below contains acetone measurements for `r n_add_cows` additional cows. Predict their methane values based on the linear regression that you found in Problem 1a). If you did not manage to solve Problem 1a) you can assume an intercept of `r n_intercept_value` and a slope of `r n_slope_value` for the prediction of methane based on acetone. Please specify whether all of the predicted methane values are valid or whether there is a problem with some of the values. If you find a problem please specify which values have a problem and what the problem is.

\textit{Die nachfolgende Tabelle enthält Acetonwerte für `r n_add_cows` zusätzliche Kühe. Berechnen Sie die geschätzten Methanwerte für diese Kühe aufgrund der geschätzten Regression aus Aufgabe 1a). Falls Sie die Aufgabe 1a) nicht gelöst haben, dann können Sie einen Achsenabschnitt von `r n_intercept_value` und eine Steigung von `r n_slope_value` für die Vorhersage der Methanwerte annehmen. Bitte geben Sie an, ob die geschätzten Methanwerte alle gültig sind oder ob es mit gewissen Werten ein Problem gibt. Falls Sie Probleme finden, geben Sie bitte an welche Werte problematisch sind und was genau das Problem ist.}

\end{enumerate}
\points{`r lPointsQ1$TaskC`}

Cows with additional acetone values

```{r, echo=FALSE}
tbl_added_ace <- tibble::tibble(Cow = c((1:n_add_cows)+n_nr_cow),
                                Acetone = vec_acetone)
knitr::kable(tbl_added_ace,
             booktabs = TRUE,
             longtable = TRUE)
```



### Solution 


\clearpage
\pagebreak

## Problem 2: Fixed Linear Effects Model
```{r asm_exam_p2_setup, echo=FALSE, message=FALSE, warning=FALSE}
s_data_url_p2 <- file.path(s_data_url_root, "asm_exam_p02.csv")
tbl_p2 <- readr::read_delim(file = s_data_url_p2, delim = ",")
n_nr_cow <- nrow(tbl_p2)
```

The dataset from Problem 1 is extended by the breed of every cow. The extended dataset is shown in the table below. The extended dataset can be read from the link shown below the table. 

\textit{Der Datensatz von Aufgabe 1 wurde um die Rasse der Kühe erweitert. Der erweiterte Datensatz ist in der nachfolgenden Tabelle gezeigt. Der erweiterte Datensatz kann vom nachfolgenden Link gelesen werden.}

```{r asm_exam_p2_show_tbl, echo=FALSE}
knitr::kable(tbl_p2,
             booktabs = TRUE,
             longtable = TRUE)

```

```{r asm_exam_p2_data_url, echo=FALSE}
cat(s_data_url_p2, "\n")
```

\begin{enumerate}
\item[a)] Fit a fixed linear effects model with methane as the response and with acetone and breed as predictor variables. 

\textit{Passen Sie ein fixes lineares Modell an mit Methan als Zielgrösse und mit Aceton und Rasse als unabhängige Variable.}

\end{enumerate}
\points{`r lPointsQ2$TaskA`}


### Solution



\clearpage
\pagebreak


\begin{enumerate}
\item[b)] Fit a fixed linear effects model with methane as response variable and the predictors acetone and breed, including an interaction term between acetone and breed. 

\textit{Passen Sie ein fixes lineares Modell an mit Methan als Zielgrösse und mit den unabhängigen Variablen Aceton und Rasse, inklusive eines Interaktionsterms zwischen Aceton und Rasse.}

\end{enumerate}
\points{`r lPointsQ2$TaskB`}


### Solution


\clearpage
\pagebreak

\begin{enumerate}
\item[c)] What are the expected methane values for the cows of a given breed and with given acetone values, using the model with and without interactions.

\textit{Welches sind die erwarteten Methanwerte für die unten aufgelisteten Kühe einer bestimmten Rassen und mit beobachteten Acetonwerten. Unterscheiden Sie dabei nach den Modellen mit und ohne Interaktion}

\end{enumerate}
\points{`r lPointsQ2$TaskC`}

```{r, echo=FALSE}
n_nr_cow_added_ace_breed <- 4
tbl_added_ace_breed <- tibble::tibble(Cow = c((1:n_nr_cow_added_ace_breed)+n_nr_cow),
                                      Acetone = c(0.0532, 0.012, 0.009, 0.0169),
                                      Breed = c(rep("Limousin", 2), rep("Angus",2)),
                                      `Expected Methane without Interaction` = c(rep("",n_nr_cow_added_ace_breed)),
                                      `Expected Methane with Interaction` = c(rep("",n_nr_cow_added_ace_breed)))
knitr::kable(tbl_added_ace_breed,
             booktabs = TRUE, 
             longtable = TRUE)
```


### Solution 


\clearpage
\pagebreak


## Problem 3: Pedigree BLUP
```{r asm-exam-p3-setup, echo=FALSE, message=FALSE}
s_data_url_p3 <- file.path(s_data_url_root, "asm_exam_p03.csv")
tbl_p3 <- readr::read_delim(file = s_data_url_p3, delim = ",")
# genetic parameters
n_va0 <- 25
n_ve0 <- 100
n_p0 <- n_va0 + n_ve0
n_vs0 <- n_va0 / 4
n_ves0 <- n_p0 - n_vs0
```

Use the data shown in the table below to fit linear mixed effects models. The column `P` corresponds to values of phenotypic observations and is to be used as response variable in the linear model. The column `Sex` contains the sex of the animal and is to be used as a fixed effect in the linear model.

\textit{Verwenden Sie die Daten in der unten gezeigten Tabelle um ein lineares gemischtes Modell anzupassen. Die Kolonne mit dem Titel `P` enthält Werte von phänotypischen Beobachtungen, welche als Zielgrössen im Modell verwendet werden sollen. Die Kolonne `Sex` enthält das Geschlecht der Tiere und soll als ein fixer Effekt ins gemischte Modell einfliessen.}

```{r asm-exam-p3-data-tbl, echo=FALSE}
knitr::kable(tbl_p3,
             booktabs = TRUE,
             longtable = TRUE)
```

```{r asm_exam_p3_data_url, echo=FALSE}
cat(s_data_url_p3, "\n")
```


\begin{enumerate}
\item[a)] Use a sire model to predict breeding values for all sires. Please specify the model in the form of an equation and explain the meaning of all model components. Write down the expected values and the variance-covariance matrices for all random effects in the model. Put all the information from the data into the model components consisting of response variable, fixed effects, random effects, and their associated design matrices. Construct the mixed model equations and provide solutions to these equations. Extract predicted breeding values from these solutions.

The following variance components can be assumed to be given as

\begin{itemize}
\item sire variance $\sigma_s^2 = `r n_vs0`$
\item residual variance $\sigma_e^2 = `r n_ves0`$
\end{itemize}

\textit{Verwenden Sie ein Vatermodell zur Schätzung der Zuchtwerte aller männlichen Tiere. Bitte geben Sie die Modellgleichung and und erläutern Sie die Bedeutung aller Modellkomponenten. Schreiben Sie die Erwartungswerte und die Varianz-Kovarianzmatrizen aller zufälligen Effekte im Modell auf. Verwenden Sie alle Informationen aus den Daten für die genaue Spezifikation der Modellkomponenten, wie zum Beispiel Zielgrösse, fixe Effekte, zufällige Effekte und die zugehörigen Designmatrizen. Stellen Sie die Mixed-Model-Gleichungen auf und lösen Sie diese Gleichungen. Extrahieren Sie die Zuchtwerte aller männlichen Tiere aus den Lösungen.}

\textit{Die folgenden Varianzkomponenten können als gegeben angenommen werden:}

\begin{itemize}
\item Sire Varianz $\sigma_s^2 = `r n_vs0`$
\item Varianz der Residuen $\sigma_e^2 = `r n_ves0`$
\end{itemize}

\end{enumerate}
\points{`r lPointsQ3$TaskA`}


### Solution



\clearpage
\pagebreak

\begin{enumerate}
\item[b)] Use an animal model to predict breeding values for all animals in the above shown dataset. Please specify the model in the form of an equation and explain the meaning of all model components. Write down the expected values and the variance-covariance matrices for all random effects in the model. Put all the information from the data into the model components consisting of response variable, fixed effects, random effects, and their associated design matrices. Construct the mixed model equations and provide solutions to these equations. Extract predicted breeding values from these solutions.

The following variance components can be assumed to be given as

\begin{itemize}
\item additive genetic variance $\sigma_u^2 = `r n_va0`$
\item residual variance $\sigma_e^2 = `r n_ve0`$
\end{itemize}

\textit{Verwenden Sie ein Tiermodell für die Schätzung der Zuchtwerte aller Tiere im oben gegebenen Datensatz.Bitte geben Sie die Modellgleichung and und erläutern Sie die Bedeutung aller Modellkomponenten. Schreiben Sie die Erwartungswerte und die Varianz-Kovarianzmatrizen aller zufälligen Effekte im Modell auf. Verwenden Sie alle Informationen aus den Daten für die genaue Spezifikation der Modellkomponenten, wie zum Beispiel Zielgrösse, fixe Effekte, zufällige Effekte und die zugehörigen Designmatrizen. Stellen Sie die Mixed-Model-Gleichungen auf und lösen Sie diese Gleichungen. Extrahieren Sie die Zuchtwerte aller männlichen Tiere aus den Lösungen.}

\textit{Die folgenden Varianzkomponenten können als gegeben angenommen werden:}

\begin{itemize}
\item Additive Genetische Varianz $\sigma_u^2 = `r n_va0`$
\item Varianz der Residuen $\sigma_e^2 = `r n_ve0`$
\end{itemize}

\end{enumerate}
\points{`r lPointsQ3$TaskB`}



### Solution



\clearpage
\pagebreak

<!--
\begin{enumerate}
\item[c)] 

\textit{}
\end{enumerate}
\points{`r lPointsQ3$TaskC`}


### Solution


\clearpage
\pagebreak

-->

## Problem 4: Genomic BLUP
```{r asm-exam-p4-setup, echo=FALSE, message=FALSE}
s_data_url_p4 <- file.path(s_data_url_root, "asm_exam_p04.csv")
tbl_p4 <- readr::read_delim(file = s_data_url_p4, delim = ",")
n_nr_snp <- length(grep("SNP", colnames(tbl_p4), fixed = TRUE))
# genetic parameters
n_va0 <- 25
n_ve0 <- 275
n_p0 <- n_va0 + n_ve0
lambda_g <- n_ve0 / n_va0
lambda_q <- lambda_g / n_nr_snp
```

Use the dataset shown in the table below to predict genomic breeding values. The column `P` contains phenotypic observations which are to be used as response variables. The column `SEX` contains the sex of the animal which is to be used as fixed effect. The columns `SNP1` to `SNP5` contain marker genotypes where the number stands for the number of favourite alleles at the respective marker position. 

\textit{Verwenden Sie den nachfolgend gezeigten Datensatz für die Schätzung von genomischen Zuchtwerten. Die Kolonne `P` enhält phänotypische Beobachtungen, welche als Zielgrössen zu verwenden sind. Die Kolonne `SEX` enthält das Geschlecht der Tiere, welche als fixe Effekte verwendet werden. Die Kolonnen `SNP1` bis `SNP5` enthalten Markergenotypen, wobei der Wert der Anzahl an positiven Allelen an der entsprechenden Markerposition entsprechen.}

```{r asm-exam-p4-data-tbl, echo=FALSE}
knitr::kable(tbl_p4,
             booktabs = TRUE,
             longtable = TRUE)
```

```{r asm_exam_p4_data_url, echo=FALSE}
cat(s_data_url_p4, "\n")
```


\begin{enumerate}
\item[a)] Use a marker effect model in a two step procedure to predict genomic breeding values for all animals shown in the above dataset. The ratio between residual variance and variance of the marker effects is $`r lambda_q`$.

\textit{Verwenden Sie ein Markereffektmodell in einem Zwei-Schritt-Verfahren um genomische Zuchtwerte für alle Tiere im oben gezeigten Datensatz zu schätzen.Das Verhältnis zwischen Restvarianz und Markervarianz beträgt} $`r lambda_q`$.

\end{enumerate}
\points{`r lPointsQ4$TaskA`}


### Solution


\clearpage
\pagebreak

\begin{enumerate}
\item[b)] Use a breeding value based model in a single step procedure to predict breeding values for all animals shown in the above dataset. The ratio between residual variance and genomic variance is $`r lambda_g`$.

\textit{Verwenden Sie ein Zuchtwert-basiertes Modell in einem Single-Step Verfahren um genomische Zuchtwerte für alle Tiere im oben gezeigten Datensatz zu schätzen. Das Verhältnis der Restvarianz zur genomischen Varianz beträgt }$`r lambda_g`$.

\end{enumerate}
\points{`r lPointsQ4$TaskB`}


### Solution


\clearpage
\pagebreak

<!--
\begin{enumerate}
\item[c)]

\textit{}

\end{enumerate}
\points{`r lPointsQ4$TaskC`}


### Solution 

  
\clearpage
\pagebreak
-->

## Problem 5: Contrasts
```{r asm-exam-p5-setup, echo=FALSE, message=FALSE}
s_data_url_p5 <- file.path(s_data_url_root, "asm_exam_p05.csv")
tbl_p5 <- readr::read_delim(file = s_data_url_p5, delim = ",")
```

The dataset shown below is used to fit a fixed linear model with `Methane` as response variable and `Breed` as predictor using different contrasts.

\textit{Der nachfolgende Datensatz wird in einem fixen linearen Modell mit `Methane` als Zielgrösse und `Breed` als unabhängiger Variablen unter Verwendung verschiedener Kontraste verwendet.}

```{r asm-exam-p5-data-tbl, echo=FALSE}
knitr::kable(tbl_p5,
             booktabs = TRUE,
             longtable = TRUE)
```

```{r asm_exam_p5_data_url, echo=FALSE}
cat(s_data_url_p5, "\n")
```


\begin{enumerate}
\item[a)] Fit a fixed linear effects model with `Methane` as response variable and with `Breed` as predictor variable. Use the `treatment` contrast to report the differences in expected levels of `Methane` for the different breeds. Verify your results by setting up the least squares normal equations and show how `treatment` contrasts are computed from these solutions.

\textit{Passen Sie ein fixes lineares Modell an die oben gezeigten Daten an mit `Methane` als Zielgrösse und mit `Breed` als unabhängiger Variable. Verwenden Sie die `treatement` Kontraste um die unterschiedlichen erwarteten Methanwerte für die verschiedenen Rassen anzugeben. Verifizieren Sie Ihre Resultate anhand der Least-Squares Normalgleichungen und berechnen Sie die `treatement` Kontraste aus den Lösungen der Normalgleichungen.}

\end{enumerate}
\points{`r lPointsQ5$TaskA`}


### Solution


\clearpage
\pagebreak


\begin{enumerate}
\item[b)] Fit a fixed linear effects model with `Methane` as response variable and with `Breed` as predictor variable. Use the `Helmert` contrast to report the differences in expected levels of `Methane` for the different breeds. Verify your results by setting up the least squares normal equations and show how `Helmert` contrasts are computed from these solutions.

\textit{Passen Sie ein fixes lineares Modell an die oben gezeigten Daten an mit `Methane` als Zielgrösse und mit `Breed` als unabhängiger Variable. Verwenden Sie die `Helmert` Kontraste um die unterschiedlichen erwarteten Methanwerte für die verschiedenen Rassen anzugeben. Verifizieren Sie Ihre Resultate anhand der Least-Squares Normalgleichungen und berechnen Sie die `Helmert` Kontraste aus den Lösungen der Normalgleichungen.}

\end{enumerate}
\points{`r lPointsQ5$TaskB`}


### Solution

<!--
\clearpage
\pagebreak

\begin{enumerate}
\item[c)]

\textit{}

\end{enumerate}
\points{`r lPointsQ5$TaskC`}


### Solution 
    
-->